---
- name: 'Check current Confluence version'
  ansible.builtin.command:
    cmd: grep -Po '(?<=^version=)\N*$' '{{ _confluence_application_path }}/confluence/META-INF/maven/com.atlassian.confluence/confluence-webapp/pom.properties'
  failed_when: false
  changed_when: false
  register: _confluence_version_check

- name: 'Download and unarchive Confluence'
  block:
    - name: 'Download Confluence archive to local folder'
      ansible.builtin.get_url:
        url: '{{ confluence_download_url }}'
        dest: '/tmp//atlassian-confluence-{{ confluence_version }}.tar.gz'
        mode: 0644
      delegate_to: localhost
      check_mode: false

    - name: 'Unarchive Confluence'
      ansible.builtin.unarchive:
        src: '/tmp/atlassian-confluence-{{ confluence_version }}.tar.gz'
        dest: '{{ _confluence_install_path }}'
        owner: '{{ confluence_username }}'
        group: '{{ confluence_group }}'
        extra_opts:
          - --strip-components=1
      when: not ansible_check_mode
      become: true
  when:
    - _confluence_version_check.stdout is not defined or
      confluence_version not in _confluence_version_check.stdout

- name: 'Create symbolic link for Confluence'
  ansible.builtin.file:
    src: '{{ _confluence_install_path }}'
    dest: '{{ _confluence_application_path }}'
    state: link
  when: not ansible_check_mode
  become: true
